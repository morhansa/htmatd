define([
    'uiComponent',
    'jquery',
    'ko',
    'intlTelInput'
], function (Component, $, ko) {
    'use strict';

    return Component.extend({
        initialize: function () {
            this._super();
            
            // Wait for address fields to appear
            var checkExist = setInterval(function() {
                if ($('input[name="telephone"]').length) {
                    clearInterval(checkExist);
                    
                    // Initialize the library on the telephone field
                    initIntlTelInput();
                }
            }, 100);
            
            function initIntlTelInput() {
                $.ajax({
                    url: '/rest/V1/directory/countries',
                    type: 'GET',
                    dataType: 'json',
                    success: function(countries) {
                        var allowedCountries = [];
                        for (var i = 0; i < countries.length; i++) {
                            allowedCountries.push(countries[i].id);
                        }
                        
                        var topDestinations = ['US', 'GB', 'DE', 'FR', 'EG', 'SA', 'AE']; // Define preferred countries
                        
                        var input = document.querySelector('input[name="telephone"]');
                        if (input) {
                            var iti = window.intlTelInput(input, {
                                preferredCountries: topDestinations,
                                onlyCountries: allowedCountries,
                                separateDialCode: true,
                                utilsScript: require.toUrl('MagoArab_WithoutEmail/js/utils.js')
                            });
                            
                            // Save value to KnockoutJS
                            $(input).on('blur', function() {
                                var viewModel = ko.dataFor(this);
                                if (viewModel && typeof viewModel.value === 'function') {
                                    viewModel.value(iti.getNumber());
                                }
                            });
                        }
                    }
                });
            }
        }
    });
});